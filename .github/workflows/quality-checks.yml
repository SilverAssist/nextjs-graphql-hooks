name: Plugin Quality Checks

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    quality-checks:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        strategy:
            matrix:
                php-version: [8.3]
                wordpress-version: [6.5, 6.6, latest]

        steps:
            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v5.2.2

            - name: Setup PHP
              uses: shivammathur/setup-php@0622dbe4675e0a51c4f8b9b0b6e7a6f6d3e6c3e3 # v2.31.1
              with:
                  php-version: ${{ matrix.php-version }}
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
                  coverage: none

            - name: Validate composer.json
              run: composer validate --strict

            - name: Install Composer dependencies
              run: composer install --prefer-dist --no-progress --no-suggest

            - name: Run PHP CodeSniffer
              run: composer run phpcs

            - name: Check PHP syntax
              run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;

    security-check:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v5.2.2

            - name: Setup PHP
              uses: shivammathur/setup-php@0622dbe4675e0a51c4f8b9b0b6e7a6f6d3e6c3e3 # v2.31.1
              with:
                  php-version: 8.3

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Run security check
              run: |
                  # Check for common security issues (excluding vendor, .github, and other non-source directories)
                  grep -r "eval(" . --exclude-dir=vendor --exclude-dir=.github --exclude-dir=node_modules --exclude-dir=.git && exit 1 || echo "✅ No eval() found"
                  grep -r "\$_GET\[" . --exclude-dir=vendor --exclude-dir=.github --exclude-dir=node_modules --exclude-dir=.git && echo "⚠️  Direct \$_GET usage found" || echo "✅ No direct \$_GET usage"
                  grep -r "\$_POST\[" . --exclude-dir=vendor --exclude-dir=.github --exclude-dir=node_modules --exclude-dir=.git && echo "⚠️  Direct \$_POST usage found" || echo "✅ No direct \$_POST usage"
                  grep -r "file_get_contents.*http" . --exclude-dir=vendor --exclude-dir=.github --exclude-dir=node_modules --exclude-dir=.git && exit 1 || echo "✅ No remote file_get_contents found"

    compatibility-check:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v5.2.2

            - name: Setup PHP
              uses: shivammathur/setup-php@0622dbe4675e0a51c4f8b9b0b6e7a6f6d3e6c3e3 # v2.31.1
              with:
                  php-version: 8.3

            - name: Check PHP 8.0+ compatibility
              run: |
                  # Check for PHP 8.0+ features usage
                  php -r "
                    if (version_compare(PHP_VERSION, '8.0.0', '<')) {
                      echo 'PHP 8.0+ required';
                      exit(1);
                    }
                    echo '✅ PHP version compatible';
                  "

            - name: WordPress compatibility check
              run: |
                  # Basic WordPress function usage validation (excluding vendor, .github, and other non-source directories)
                  grep -r "add_action\|add_filter\|wp_enqueue" . --exclude-dir=vendor --exclude-dir=.github --exclude-dir=node_modules --exclude-dir=.git && echo "✅ WordPress functions found" || echo "⚠️  No WordPress functions detected"
